<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - KaosSub</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/favicon/favicon.png">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/favicon/favicon.png">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg">
    <meta name="theme-color" content="#dc3545">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #343a40, #495057);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #007bff;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .admin-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .otp-form {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }
        
        .otp-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 10px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .admin-nav .btn {
            background: #6c757d;
            color: white;
        }
        
        .admin-nav .btn:hover {
            background: #545b62;
        }
        
        .recent-orders {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .order-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-status.success {
            color: #28a745;
            font-weight: bold;
        }
        
        .order-status.failed {
            color: #dc3545;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-secondary {
            background-color: #6c757d;
            color: white;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-info {
            background-color: #17a2b8;
            color: white;
        }

        .badge-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
/* Add to your admin styles */
.settings-category {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
}

.settings-category h4 {
    color: #495057;
    font-weight: 600;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-control:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-danger:hover {
    background-color: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    border-radius: 3px;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 10px;
    border-radius: 5px;
    margin: 10px 0;
}

    </style>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/js/url-config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>KaosSub</h1>
            <nav style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem;">
                <a href="/" style="text-decoration: none; color: #333; font-weight: 500;">Home</a>
                <a href="/dashboard" style="text-decoration: none; color: #333; font-weight: 500;">Dashboard</a>
                <a href="/admin" style="text-decoration: none; color: #333; font-weight: 500;">Admin</a>
                <a href="/data-plans" style="text-decoration: none; color: #333; font-weight: 500;">Data Plans</a>
                <a href="/contact" style="text-decoration: none; color: #333; font-weight: 500;">Contact</a>
            </nav>
        </header>

        <main>
            <div class="admin-container">
                <!-- OTP Verification Section -->
                <div id="otpSection" class="admin-section">
                    <div class="otp-form">
                        <h2>Admin Verification Required</h2>
                        <p>To access the admin dashboard, please verify your identity with an OTP.</p>
                        
                        <button onclick="requestOTP()" class="btn" id="requestOtpBtn">
                            Send OTP to Email
                        </button>
                        
                        <div id="otpInputSection" class="hidden" style="margin-top: 20px;">
                            <p>Enter the OTP sent to your email:</p>
                            <input type="text" id="otpCode" class="form-control otp-input" maxlength="6" placeholder="000000">
                            <button onclick="verifyOTP()" class="btn" id="verifyOtpBtn" style="margin-top: 10px;">
                                Verify OTP
                            </button>
                        </div>
                        
                        <div id="otpMessage" style="margin-top: 15px;"></div>
                    </div>
                </div>

                <!-- Admin Dashboard (hidden until OTP verification) -->
                <div id="adminDashboard" class="hidden">
                    <div class="admin-header">
                        <h1>Admin Dashboard</h1>
                        <p>Welcome back, <span id="adminName">Admin</span>!</p>
                    </div>

                    <div class="admin-nav">
                        <button class="btn" onclick="loadStats()">Refresh Stats</button>
                        <button class="btn" onclick="loadUserManagement()">User Management</button>
                        <button class="btn" onclick="loadOrderManagement()">Order Management</button>
                        <button class="btn" onclick="loadSystemSettings()">System Settings</button>
                        <button class="btn" onclick="testAllEndpoints()" style="background: #17a2b8;">Debug APIs</button>
                        <button class="btn" onclick="adminLogout()" style="background: #dc3545;">Logout Admin</button>
                    </div>

                    <!-- Admin Dasboard Debug Section -->
                    <div class="admin-section" id="debugSection" style="display: none;">
                        <h2>üêõ Debug Information</h2>
                        <div class="debug-info" id="debugInfo">
                            Debug information will appear here...
                        </div>
                        <button class="btn btn-sm" onclick="clearDebug()">Clear Debug</button>
                    </div>

                    <!-- Statistics Section -->
                    <div class="admin-section">
                        <h2>üìä System Overview</h2>
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalOrders">0</div>
                                <div class="stat-label">Total Orders</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="totalRevenue">‚Ç¶0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="successRate">0%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders Section -->
                    <div class="admin-section">
                        <h2>üìã Recent Orders</h2>
                        <div class="recent-orders" id="recentOrders">
                            <p>Loading recent orders...</p>
                        </div>
                    </div>

                    <!-- User Management Section -->
                    <div class="admin-section hidden" id="userManagementSection">
                        <h2>üë• User Management</h2>
                        <p>Manage user accounts, roles, and permissions.</p>
                        <div id="userManagementContent">
                            <p>Loading user data...</p>
                        </div>
                    </div>

                    <!-- Order Management Section -->
                    <div class="admin-section hidden" id="orderManagementSection">
                        <h2>üõí Order Management</h2>
                        <p>View and manage all data purchase orders.</p>
                        <div id="orderManagementContent">
                            <p>Loading order data...</p>
                        </div>
                    </div>

                    <!-- System Settings Section -->
                    <div class="admin-section hidden" id="systemSettingsSection">
                        <h2>‚öôÔ∏è System Settings</h2>
                        <p>Configure system-wide settings and preferences.</p>
                        <div id="systemSettingsContent">
                            <p>Loading system settings...</p>
                        </div>
                    </div>
                </div>

                <!-- Access Denied Section -->
                <div id="accessDeniedSection" class="admin-section hidden">
                    <div style="text-align: center; color: #dc3545;">
                        <h2>üö´ Access Denied</h2>
                        <p>You do not have administrator privileges to access this page.</p>
                        <a href="/dashboard" class="btn">Go to Dashboard</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Enhanced Session management functions
        const AdminSession = {
            // Save admin session with user ID
            saveSession: function(sessionData) {
                try {
                    const currentUserId = Utils.getCurrentUserId();
                    if (!currentUserId) {
                        console.error('‚ùå Cannot save admin session: No current user ID');
                        return;
                    }

                    const session = {
                        ...sessionData,
                        user_id: currentUserId, // Always use current user ID
                        created_at: new Date().toISOString()
                    };
                    sessionStorage.setItem('adminSession', JSON.stringify(session));
                    console.log('üíæ Admin session saved for user:', currentUserId);
                } catch (error) {
                    console.error('‚ùå Failed to save admin session:', error);
                }
            },

            // Get admin session - check if it matches current user
            getSession: function() {
                try {
                    const session = sessionStorage.getItem('adminSession');
                    if (!session) {
                        console.log('‚ùå No admin session found');
                        return null;
                    }
                    
                    const sessionData = JSON.parse(session);
                    const currentUserId = Utils.getCurrentUserId();
                    
                    if (!currentUserId) {
                        console.log('‚ùå Cannot verify admin session: No current user ID');
                        this.clearSession();
                        return null;
                    }

                    // Check if session belongs to current user
                    if (sessionData.user_id !== currentUserId) {
                        console.log('‚ùå Admin session belongs to different user, clearing...', {
                            sessionUserId: sessionData.user_id,
                            currentUserId: currentUserId
                        });
                        this.clearSession();
                        return null;
                    }
                    
                    // Check if session is expired (8 hours)
                    if (this.isSessionExpired(sessionData)) {
                        console.log('‚ùå Admin session expired');
                        this.clearSession();
                        return null;
                    }
                    
                    console.log('‚úÖ Valid admin session found for current user:', currentUserId);
                    return sessionData;
                } catch (error) {
                    console.error('‚ùå Failed to get admin session:', error);
                    return null;
                }
            },

            // Check if session is expired (8 hours)
            isSessionExpired: function(sessionData) {
                if (!sessionData.created_at) return true;
                
                const sessionTime = new Date(sessionData.created_at);
                const currentTime = new Date();
                const hoursDiff = (currentTime - sessionTime) / (1000 * 60 * 60);
                
                return hoursDiff > 8; // 8 hours expiry
            },

            // Clear admin session
            clearSession: function() {
                sessionStorage.removeItem('adminSession');
                console.log('üóëÔ∏è Admin session cleared');
            },

            // Check if user has valid admin session
            hasValidSession: function() {
                const session = this.getSession();
                const hasSession = session !== null;
                console.log('üîê Admin session valid?', hasSession);
                return hasSession;
            }
        };

        // Debug utilities
        function debugLog(message, data = null) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            let logEntry = `[${timestamp}] ${message}`;
            
            if (data) {
                logEntry += `\n${JSON.stringify(data, null, 2)}`;
            }
            
            debugInfo.innerHTML = logEntry + '\n\n' + debugInfo.innerHTML;
            console.log(`üîç ${message}`, data || '');
        }

        function showDebugSection() {
            document.getElementById('debugSection').style.display = 'block';
        }

        function clearDebug() {
            document.getElementById('debugInfo').innerHTML = 'Debug information will appear here...';
        }

        // Test all API endpoints
        async function testAllEndpoints() {
            showDebugSection();
            debugLog('üß™ Testing all admin API endpoints...');
            
            const endpoints = [
                '/api/admin/stats',
                '/api/admin/users',
                '/api/admin/users/stats',
                '/api/admin/orders'
            ];

            for (const endpoint of endpoints) {
                try {
                    debugLog(`Testing: ${endpoint}`);
                    const response = await Utils.apiRequest(endpoint);
                    debugLog(`‚úÖ ${endpoint} - Success`, response);
                } catch (error) {
                    debugLog(`‚ùå ${endpoint} - Failed`, error.message);
                }
                await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between requests
            }
            
            debugLog('üéØ All endpoint tests completed');
        }

        // Enhanced check for existing admin session on page load
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üîÑ Admin page loaded, checking authentication and session...');
            
            // First check if user is authenticated
            if (!Utils.isAuthenticated()) {
                debugLog('‚ùå User not authenticated');
                document.getElementById('accessDeniedSection').classList.remove('hidden');
                return;
            }
            
            const currentUserId = Utils.getCurrentUserId();
            debugLog('üîç Current user ID:', currentUserId);
            
            // Clear any admin session that doesn't belong to current user
            const adminSession = AdminSession.getSession();
            if (adminSession && adminSession.user_id !== currentUserId) {
                debugLog('‚ùå Admin session belongs to different user, clearing...');
                AdminSession.clearSession();
            }
            
            debugLog('‚úÖ User authenticated, checking admin status...');
            // Check admin status
            checkAdminStatus();
        });

        // Check admin status and session
        async function checkAdminStatus() {
            try {
                debugLog('üîê Checking admin status...');
                const response = await Utils.apiRequest('/api/admin/check-status');
                debugLog('Admin status response:', response);
                
                if (response.success && response.data.is_admin) {
                    // User is admin, check for valid session
                    if (AdminSession.hasValidSession()) {
                        debugLog('‚úÖ Valid admin session found');
                        document.getElementById('otpSection').classList.add('hidden');
                        document.getElementById('adminDashboard').classList.remove('hidden');
                        loadStats();
                    } else {
                        debugLog('‚ö†Ô∏è No valid admin session, showing OTP section');
                        document.getElementById('otpSection').classList.remove('hidden');
                    }
                } else {
                    debugLog('‚ùå User is not an admin');
                    document.getElementById('accessDeniedSection').classList.remove('hidden');
                }
            } catch (error) {
                debugLog('‚ùå Failed to check admin status:', error);
                document.getElementById('accessDeniedSection').classList.remove('hidden');
            }
        }

        // Request OTP
        async function requestOTP() {
            const button = document.getElementById('requestOtpBtn');
            const originalText = Utils.showLoading(button);

            try {
                debugLog('üìß Requesting admin OTP...');
                const response = await Utils.apiRequest('/api/admin/request-otp', {
                    method: 'POST'
                });

                debugLog('OTP request response:', response);

                if (response.success) {
                    showMessage('OTP sent successfully! Check your email (and console for demo).', 'success');
                    document.getElementById('otpInputSection').classList.remove('hidden');
                    document.getElementById('otpCode').focus();
                } else {
                    showMessage(response.error || 'Failed to send OTP', 'error');
                }
            } catch (error) {
                showMessage(error.message, 'error');
                debugLog('‚ùå OTP request failed:', error);
            } finally {
                Utils.hideLoading(button, originalText);
            }
        }

        // Verify OTP
        async function verifyOTP() {
            const otpCode = document.getElementById('otpCode').value;
            const button = document.getElementById('verifyOtpBtn');
            
            if (!otpCode || otpCode.length !== 6) {
                showMessage('Please enter a valid 6-digit OTP', 'error');
                return;
            }

            const originalText = Utils.showLoading(button);

            try {
                debugLog('üîê Verifying OTP...', { otpCode });
                const response = await Utils.apiRequest('/api/admin/verify-otp', {
                    method: 'POST',
                    body: JSON.stringify({ otp_code: otpCode })
                });
                
                debugLog('OTP verification response:', response);

                if (response.success) {
                    // Save admin session
                    AdminSession.saveSession(response.data.session);
                    
                    showMessage('Admin verification successful!', 'success');
                    
                    // Show admin dashboard
                    document.getElementById('otpSection').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    
                    // Load initial data
                    loadStats();
                } else {
                    showMessage(response.error || 'Invalid OTP', 'error');
                }
            } catch (error) {
                showMessage(error.message, 'error');
                debugLog('‚ùå OTP verification failed:', error);
            } finally {
                Utils.hideLoading(button, originalText);
            }
        } 

        // Load admin statistics
        async function loadStats() {
            try {
                debugLog('üìä Loading admin statistics...');
                const response = await Utils.apiRequest('/api/admin/stats');
                debugLog('Stats response:', response);

                if (response.success) {
                    const stats = response.data;
                    debugLog('Stats data:', stats);

                    // Update stats display
                    document.getElementById('totalUsers').textContent = stats.total_users;
                    document.getElementById('totalOrders').textContent = stats.total_orders;
                    document.getElementById('totalRevenue').textContent = Utils.formatCurrency(stats.total_revenue);

                    // Calculate success rate
                    const successRate = stats.total_orders > 0 ? '95%' : '0%';
                    document.getElementById('successRate').textContent = successRate;

                    // Display recent orders
                    displayRecentOrders(stats.recent_orders);
                }
            } catch (error) {
                debugLog('‚ùå Failed to load stats:', error);
            }
        }

        // Display recent orders
        function displayRecentOrders(orders) {
            const container = document.getElementById('recentOrders');
            debugLog('üìã Displaying recent orders:', orders);

            if (!orders || orders.length === 0) {
                container.innerHTML = '<p>No recent orders found.</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-item">
                    <div>
                        <strong>${order.profiles?.email || 'Unknown User'}</strong>
                        <div style="font-size: 12px; color: #666;">
                            ${order.networks?.name} - ${order.data_plans?.name}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="order-status ${order.status}">${order.status}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${Utils.formatCurrency(order.amount_paid)}
                        </div>
                    </div>
                </div>
            `).join('');
        }

       // Enhanced User Management with better error handling
        async function loadUserManagement() {
            try {
                debugLog('üîÑ Loading user management...');
                
                hideAllSections();
                document.getElementById('userManagementSection').classList.remove('hidden');

                // Show loading state
                document.getElementById('userManagementContent').innerHTML = '<p>Loading user data...</p>';

                // Make API requests with detailed logging and timeout
                debugLog('üìä Making users API request...');
                const usersResponse = await Utils.apiRequest('/api/admin/users');
                debugLog('üìä Users API Response:', usersResponse);
                
                if (!usersResponse) {
                    throw new Error('No response from server - possible network issue');
                }

                if (usersResponse.success) {
                    const userStatsResponse = await Utils.apiRequest('/api/admin/users/stats');
                    debugLog('üìà User Stats API Response:', userStatsResponse);

                    // Debug the data structure
                    debugLog('üîç Users data structure:', usersResponse.data);
                    debugLog('üîç User stats structure:', userStatsResponse.data);
                    
                    // Try different ways to access the data
                    const users = usersResponse.data.users || usersResponse.data;
                    debugLog('üë• Final users array:', users);
                    
                    if (users && Array.isArray(users)) {
                        displayUsers(users);
                        if (userStatsResponse.success) {
                            displayUserStats(userStatsResponse.data);
                        }
                    } else {
                        throw new Error('Invalid users data format');
                    }
                } else {
                    throw new Error(usersResponse.error || 'Failed to load users');
                }
            } catch (error) {
                debugLog('‚ùå Failed to load user management:', error);
                const errorMessage = error.message || 'Unknown error occurred';
                
                // Show user-friendly error message
                document.getElementById('userManagementContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <h3>‚ùå Error Loading Users</h3>
                        <p>${errorMessage}</p>
                        <p style="font-size: 14px; color: #666;">Please check the server logs and try again.</p>
                        <button class="btn" onclick="loadUserManagement()" style="margin-top: 15px;">Retry</button>
                    </div>
                `;
                
                showMessage('Failed to load user data: ' + errorMessage, 'error');
            }
        }

        function displayUsers(users) {
    const container = document.getElementById('userManagementSection');
    
    if (!users || !Array.isArray(users)) {
        debugLog('‚ùå Users data is not an array:', users);
        container.innerHTML = '<p>Error: Users data format is invalid</p>';
        return;
    }
    
    debugLog(`üë• Displaying ${users.length} users`);
    
    const usersHTML = `
        <div style="margin-bottom: 20px;">
            <h3>User List (${users.length} users)</h3>
            <div style="margin-bottom: 15px;">
                <div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px;">
                    <strong>‚ö†Ô∏è Warning:</strong> Deleting a user will permanently remove all their data including orders, transactions, and wallet history.
                </div>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Email</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Name</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Role</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Balance</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Joined</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${user.email || 'N/A'}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${user.full_name || 'N/A'}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <span class="badge ${user.role === 'admin' ? 'badge-success' : 'badge-secondary'}">${user.role || 'user'}</span>
                                </td>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${Utils.formatCurrency(user.balance || 0)}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">${new Date(user.created_at).toLocaleDateString()}</td>
                                <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        ${user.role === 'user' ? 
                                            `<button class="btn btn-sm" onclick="makeAdmin('${user.id}')" title="Make Admin">
                                                <i class="fas fa-user-shield"></i>
                                            </button>` :
                                            `<button class="btn btn-sm btn-secondary" onclick="makeUser('${user.id}')" title="Make Regular User">
                                                <i class="fas fa-user"></i>
                                            </button>`
                                        }
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}', '${user.email}')" title="Delete User">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    container.innerHTML = usersHTML;
}

        function displayUserStats(stats) {
            debugLog('üìà Displaying user stats:', stats);
            
            const statsHTML = `
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_users || 0}</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.active_users || 0}</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.new_users_today || 0}</div>
                        <div class="stat-label">New Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.new_users_this_week || 0}</div>
                        <div class="stat-label">New This Week</div>
                    </div>
                </div>
            `;
            
            document.getElementById('userManagementSection').innerHTML = statsHTML + document.getElementById('userManagementSection').innerHTML;
        }

        // Enhanced Order Management with debugging
        async function loadOrderManagement() {
            try {
                debugLog('üîÑ Loading order management...');
                
                hideAllSections();
                document.getElementById('orderManagementSection').classList.remove('hidden');

                const response = await Utils.apiRequest('/api/admin/orders');
                debugLog('üì¶ Orders API Response:', response);

                if (response.success) {
                    // Debug the data structure
                    debugLog('üîç Orders data structure:', response.data);
                    
                    // Try different ways to access the data
                    const orders = response.data.orders || response.data;
                    debugLog('üìã Final orders array:', orders);
                    
                    displayOrders(orders);
                } else {
                    throw new Error('Failed to load orders');
                }
            } catch (error) {
                debugLog('‚ùå Failed to load order management:', error);
                showMessage('Failed to load orders: ' + error.message, 'error');
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('orderManagementSection');
            
            // Ensure orders is an array
            if (!orders || !Array.isArray(orders)) {
                debugLog('‚ùå Orders data is not an array:', orders);
                container.innerHTML = '<p>Error: Orders data format is invalid</p>';
                return;
            }
            
            debugLog(`üìã Displaying ${orders.length} orders`);
            
            const ordersHTML = `
                <div style="max-height: 500px; overflow-y: auto;">
                    <h3>Order List (${orders.length} orders)</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">User</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Network</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Plan</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Phone</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Amount</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Status</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Date</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orders.map(order => `
                                <tr>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${order.profiles?.email || 'Unknown'}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${order.networks?.name || 'N/A'}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${order.data_plans?.name || 'N/A'}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${order.phone_number}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${Utils.formatCurrency(order.amount_paid)}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                        <span class="badge badge-${getStatusBadgeClass(order.status)}">${order.status}</span>
                                    </td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${new Date(order.created_at).toLocaleDateString()}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">
                                        <select onchange="updateOrderStatus('${order.id}', this.value)" style="padding: 5px; border-radius: 3px; border: 1px solid #ddd;">
                                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                                            <option value="success" ${order.status === 'success' ? 'selected' : ''}>Success</option>
                                            <option value="failed" ${order.status === 'failed' ? 'selected' : ''}>Failed</option>
                                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                        </select>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = ordersHTML;
        }

        // Navigation functions
        function showUserManagement() {
            hideAllSections();
            document.getElementById('userManagementSection').classList.remove('hidden');
        }

        function showOrderManagement() {
            hideAllSections();
            document.getElementById('orderManagementSection').classList.remove('hidden');
        }

        function showSystemSettings() {
            hideAllSections();
            document.getElementById('systemSettingsSection').classList.remove('hidden');
        }

        function hideAllSections() {
            const sections = [
                'userManagementSection',
                'orderManagementSection',
                'systemSettingsSection'
            ];

            sections.forEach(section => {
                document.getElementById(section).classList.add('hidden');
            });
        }

        // Utility function to show messages
        function showMessage(message, type) {
            if (message && typeof message === "object") {
                message = message.message || JSON.stringify(message);
            }
            const messageDiv = document.getElementById('otpMessage');
            messageDiv.textContent = message;
            messageDiv.className = `alert alert-${type}`;
            messageDiv.style.display = 'block';
        }

        // User Management Functions
        async function makeAdmin(userId) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            try {
                debugLog(`üîÑ Making user ${userId} an admin...`);
                const response = await Utils.apiRequest(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    body: JSON.stringify({ role: 'admin' })
                });

                if (response.success) {
                    showMessage('User role updated to admin', 'success');
                    loadUserManagement();
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                showMessage('Failed to update user role: ' + error.message, 'error');
                debugLog('‚ùå Make admin failed:', error);
            }
        }

        async function makeUser(userId) {
            if (!confirm('Are you sure you want to make this admin a regular user?')) return;
            
            try {
                debugLog(`üîÑ Making admin ${userId} a regular user...`);
                const response = await Utils.apiRequest(`/api/admin/users/${userId}/role`, {
                    method: 'PUT',
                    body: JSON.stringify({ role: 'user' })
                });

                if (response.success) {
                    showMessage('User role updated to regular user', 'success');
                    loadUserManagement();
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                showMessage('Failed to update user role: ' + error.message, 'error');
                debugLog('‚ùå Make user failed:', error);
            }
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'success': 'success',
                'failed': 'danger',
                'pending': 'warning',
                'processing': 'info',
                'cancelled': 'secondary'
            };
            return classes[status] || 'secondary';
        }

        async function updateOrderStatus(orderId, status) {
            try {
                debugLog(`üîÑ Updating order ${orderId} status to: ${status}`);
                const response = await Utils.apiRequest(`/api/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });

                if (response.success) {
                    showMessage('Order status updated successfully', 'success');
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                showMessage('Failed to update order status: ' + error.message, 'error');
                debugLog('‚ùå Update order status failed:', error);
            }
        }

        // Enhanced loadSystemSettings function
async function loadSystemSettings() {
    try {
        debugLog('‚öôÔ∏è Loading system settings...');
        hideAllSections();
        document.getElementById('systemSettingsSection').classList.remove('hidden');

        // Show loading state
        document.getElementById('systemSettingsContent').innerHTML = '<p>Loading system settings...</p>';

        const response = await Utils.apiRequest('/api/admin/settings');
        debugLog('System settings response:', response);

        if (response.success) {
            displaySystemSettings(response.data);
        } else {
            throw new Error('Failed to load system settings');
        }
    } catch (error) {
        debugLog('‚ùå Failed to load system settings:', error);
        document.getElementById('systemSettingsContent').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
                <h3>‚ùå Error Loading Settings</h3>
                <p>${error.message}</p>
                <button class="btn" onclick="loadSystemSettings()" style="margin-top: 15px;">Retry</button>
            </div>
        `;
    }
}

// Enhanced displaySystemSettings function
function displaySystemSettings(data) {
    debugLog('‚öôÔ∏è Displaying system settings:', data);
    const container = document.getElementById('systemSettingsContent');
    const settings = data.settings || {};
    const categories = data.settings_by_category || {};

    let settingsHTML = `
        <div style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>System Configuration</h3>
                <div>
                    <button class="btn btn-secondary" onclick="loadSystemSettings()" style="margin-right: 10px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-warning" onclick="resetSystemSettings()">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p><strong>Last Updated:</strong> ${new Date(data.updated_at).toLocaleString()}</p>
            </div>
    `;

    // Display settings by category
    for (const [category, categorySettings] of Object.entries(categories)) {
        settingsHTML += `
            <div class="settings-category" style="margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                <h4 style="margin-bottom: 15px; color: #495057; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    ${category.charAt(0).toUpperCase() + category.slice(1)} Settings
                </h4>
                <div class="settings-grid" style="display: grid; gap: 15px;">
        `;

        categorySettings.forEach(setting => {
            const inputId = `setting_${setting.setting_key}`;
            let inputField = '';

            switch (setting.setting_type) {
                case 'boolean':
                    inputField = `
                        <select id="${inputId}" class="form-control">
                            <option value="true" ${setting.parsed_value ? 'selected' : ''}>Enabled</option>
                            <option value="false" ${!setting.parsed_value ? 'selected' : ''}>Disabled</option>
                        </select>
                    `;
                    break;
                case 'number':
                    inputField = `<input type="number" id="${inputId}" class="form-control" value="${setting.parsed_value}">`;
                    break;
                case 'json':
                    inputField = `<textarea id="${inputId}" class="form-control" rows="3">${JSON.stringify(setting.parsed_value, null, 2)}</textarea>`;
                    break;
                default:
                    inputField = `<input type="text" id="${inputId}" class="form-control" value="${setting.parsed_value || ''}">`;
            }

            settingsHTML += `
                <div class="form-group">
                    <label for="${inputId}" style="font-weight: 500;">${setting.setting_key.replace(/_/g, ' ').toUpperCase()}:</label>
                    ${inputField}
                    ${setting.description ? `<small style="color: #666; display: block; margin-top: 5px;">${setting.description}</small>` : ''}
                </div>
            `;
        });

        settingsHTML += `
                </div>
            </div>
        `;
    }

    settingsHTML += `
            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveSystemSettings()" style="margin-right: 10px;">
                    <i class="fas fa-save"></i> Save All Settings
                </button>
                <button class="btn btn-info" onclick="testSettings()">
                    <i class="fas fa-vial"></i> Test Settings
                </button>
            </div>
        </div>
    `;

    container.innerHTML = settingsHTML;
}

// Enhanced saveSystemSettings function
async function saveSystemSettings() {
    try {
        debugLog('üíæ Saving system settings...');
        
        // Collect all settings from the form
        const settings = {};
        const inputs = document.querySelectorAll('#systemSettingsContent [id^="setting_"]');
        
        inputs.forEach(input => {
            const key = input.id.replace('setting_', '');
            let value = input.value;
            
            // Convert values based on input type
            if (input.type === 'number') {
                value = parseFloat(value);
            } else if (input.tagName === 'SELECT') {
                value = value === 'true';
            } else if (input.tagName === 'TEXTAREA') {
                try {
                    value = JSON.parse(value);
                } catch (e) {
                    // Keep as string if not valid JSON
                }
            }
            
            settings[key] = value;
        });

        debugLog('üìù Settings to save:', settings);

        const response = await Utils.apiRequest('/api/admin/settings', {
            method: 'PUT',
            body: JSON.stringify({ settings })
        });

        if (response.success) {
            showMessage('System settings saved successfully!', 'success');
            debugLog('‚úÖ Settings saved:', response.data);
            // Reload settings to show updated values
            loadSystemSettings();
        } else {
            throw new Error(response.error);
        }
    } catch (error) {
        debugLog('‚ùå Failed to save settings:', error);
        showMessage('Failed to save settings: ' + error.message, 'error');
    }
}

// Reset settings function
async function resetSystemSettings() {
    if (!confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        return;
    }

    try {
        debugLog('üîÑ Resetting system settings...');
        const response = await Utils.apiRequest('/api/admin/settings/reset', {
            method: 'POST'
        });

        if (response.success) {
            showMessage('System settings reset to defaults successfully!', 'success');
            loadSystemSettings(); // Reload the settings
        } else {
            throw new Error(response.error);
        }
    } catch (error) {
        debugLog('‚ùå Failed to reset settings:', error);
        showMessage('Failed to reset settings: ' + error.message, 'error');
    }
}

// Test settings function
async function testSettings() {
    debugLog('üß™ Testing system settings...');
    showMessage('Testing settings functionality...', 'info');
    
    // Test each setting category
    try {
        const response = await Utils.apiRequest('/api/admin/settings');
        if (response.success) {
            const settings = response.data.settings;
            let testResults = [];
            
            // Test maintenance mode
            if (settings.maintenance_mode) {
                testResults.push('‚ö†Ô∏è Maintenance mode is ENABLED - users cannot access the site');
            } else {
                testResults.push('‚úÖ Maintenance mode is disabled');
            }
            
            // Test registration
            if (settings.registration_enabled) {
                testResults.push('‚úÖ User registration is enabled');
            } else {
                testResults.push('‚ö†Ô∏è User registration is DISABLED - new users cannot register');
            }
            
            // Test notifications
            if (settings.enable_email_notifications) {
                testResults.push('‚úÖ Email notifications are enabled');
            } else {
                testResults.push('‚ÑπÔ∏è Email notifications are disabled');
            }
            
            if (settings.enable_sms_notifications) {
                testResults.push('‚úÖ SMS notifications are enabled');
            } else {
                testResults.push('‚ÑπÔ∏è SMS notifications are disabled');
            }
            
            // Show test results
            const resultsHTML = testResults.map(result => `<div style="margin: 5px 0;">${result}</div>`).join('');
            showMessage(`<strong>Settings Test Results:</strong><br>${resultsHTML}`, 'info');
        }
    } catch (error) {
        debugLog('‚ùå Settings test failed:', error);
        showMessage('Failed to test settings: ' + error.message, 'error');
    }
}

// Delete user function
async function deleteUser(userId, userEmail) {
    if (!confirm(`üö® DANGER: This will permanently delete user "${userEmail}" and ALL their data!\n\nThis includes:\n‚Ä¢ All orders\n‚Ä¢ All transactions\n‚Ä¢ Wallet history\n‚Ä¢ Session data\n‚Ä¢ OTP records\n‚Ä¢ User profile\n\nThis action cannot be undone!\n\nAre you absolutely sure?`)) {
        return;
    }

    // Extra confirmation for destructive action
    const confirmed = confirm(`‚ö†Ô∏è FINAL WARNING: You are about to PERMANENTLY DELETE user "${userEmail}" and all their data. This cannot be recovered!\n\nType "DELETE" to confirm:`);
    
    if (!confirmed) {
        return;
    }

    const userInput = prompt(`Please type "DELETE" to confirm permanent deletion of user "${userEmail}":`);
    
    if (userInput !== 'DELETE') {
        showMessage('User deletion cancelled. Confirmation text did not match.', 'warning');
        return;
    }

    try {
        debugLog(`üóëÔ∏è Deleting user: ${userId} (${userEmail})`);
        showMessage('Deleting user and all associated data...', 'info');

        const response = await Utils.apiRequest(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        });

        if (response.success) {
            showMessage(`‚úÖ User "${userEmail}" and all associated data deleted successfully!`, 'success');
            debugLog('‚úÖ User deletion successful:', response.data);
            
            // Reload user management to reflect changes
            setTimeout(() => {
                loadUserManagement();
            }, 2000);
        } else {
            throw new Error(response.error);
        }
    } catch (error) {
        debugLog('‚ùå User deletion failed:', error);
        showMessage('Failed to delete user: ' + error.message, 'error');
    }
}

        // Admin logout function
        function adminLogout() {
            if (confirm('Are you sure you want to logout from admin dashboard?')) {
                debugLog('üö™ Admin logging out...');
                AdminSession.clearSession();
                window.location.reload();
            }
        }
    </script>
    <!-- Load Footer Component -->
    <script src="/js/components/footer.js"></script>
    
    <!-- Form Handler -->
    <!-- Hamburger Menu -->
    <script src="/js/components/hamburger-menu.js"></script>
    <script src="/js/components/simple-form-handler.js"></script>
</body>
</html>
