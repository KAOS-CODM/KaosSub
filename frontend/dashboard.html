<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - KaosSub</title>
    <!--Favicon-->
    <link rel="icon" type="image/x-icon" href="/assets/favicon/favicon.ico">
    <link rel="icon" type="image/png" href="/assets/favicon/favicon.png">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/favicon/favicon.png">
    <link rel="icon" type="image/svg+xml" href="/assets/favicon/favicon.svg">
    <meta name="theme-color" content="#dc3545">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { margin: 0 0 10px 0; color: #666; font-size: 14px; }
        .stat-card .amount { font-size: 24px; font-weight: bold; color: #007bff; }
        .dashboard-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .action-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .payment-form { display: flex; gap: 10px; margin-top: 15px; }
        .payment-form input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .recent-activity { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .activity-list { max-height: 300px; overflow-y: auto; }
        .activity-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .activity-item:last-child { border-bottom: none; }
        .activity-type { font-weight: bold; }
        .activity-amount.credit { color: #28a745; }
        .activity-amount.debit { color: #dc3545; }
        .activity-date { color: #666; font-size: 12px; }
        .status-processing { color: #ffc107; font-weight: bold; }
        .status-success { color: #28a745; font-weight: bold; }
        .status-failed { color: #dc3545; font-weight: bold; }
        @media (max-width: 768px) {
            .dashboard-actions { grid-template-columns: 1fr; }
            .payment-form { flex-direction: column; }
        }
    </style>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/js/url-config.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>KaosSub</h1>
        <nav style="display: flex; justify-content: center; gap: 1.5rem; flex-wrap: wrap; margin-top: 1rem;">
            <a href="/" style="text-decoration: none; color: #333; font-weight: 500;">Home</a>
            <a href="/dashboard" style="text-decoration: none; color: #333; font-weight: 500;">Dashboard</a>
            <a href="/data-plans" style="text-decoration: none; color: #333; font-weight: 500;">Data Plans</a>
            <a href="/history" style="text-decoration: none; color: #333; font-weight: 500;">History</a>
            <a href="/contact" style="text-decoration: none; color: #333; font-weight: 500;">Contact</a>
        </nav>
        </header>

        <main>
            <div class="page-header">
                <h2>Welcome, <span id="userName">User</span>!</h2>
                <p>Manage your account and purchase data bundles</p>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Current Balance</h3>
                    <div class="amount" id="currentBalance">‚Ç¶0.00</div>
                </div>
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="amount" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Successful Orders</h3>
                    <div class="amount" id="successfulOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Processing Orders</h3>
                    <div class="amount" id="processingOrders">0</div>
                </div>
            </div>

            <!-- Add this after the dashboard-stats div -->
            <div class="admin-access-panel hidden" id="adminAccessPanel" style="background: linear-gradient(135deg, #dc3545, #c82333); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                <h3>üîê Administrator Access</h3>
                <p>You have administrator privileges. Access the admin panel to manage users, orders, and system settings.</p>
                <a href="/admin" class="btn" style="background: white; color: #dc3545; border: none; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold;">
                    Open Admin Panel
                </a>
            </div>

            <div class="dashboard-actions">
                <div class="action-card">
                    <h3>Fund Wallet</h3>
                    <p>Add money to your wallet to purchase data bundles</p>
                    <div class="payment-form">
                        <input type="number" id="amountInput" placeholder="Enter amount (‚Ç¶)" min="100" step="100">
                        <button onclick="initializePayment('amountInput', 'paymentError')" class="btn">Pay with Paystack</button>
                    </div>
                    <div id="paymentError" class="alert alert-error" style="display: none; margin-top: 10px;"></div>
                </div>

                <div class="action-card">
                    <h3>Quick Actions</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <a href="/data-plans" class="btn" style="text-align: center;">Buy Data Bundle</a>
                        <a href="/history?tab=transactions" class="btn btn-secondary">View Payment History</a>
                        <a href="/history?tab=wallet" class="btn btn-secondary">View Wallet History</a>
                        <a href="/history?tab=orders" class="btn btn-secondary">View All Orders</a>
                    </div>
                </div>
            </div>

            <div class="recent-activity">
                <h3>Recent Orders</h3>
                <div class="activity-list" id="recentActivity">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Loading recent orders...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/utils.js"></script>
    <script src="js/payment.js"></script>
    <script src="js/app.js"></script>

    <script>
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
        }
    </script>
    <script>
        let walletTransactions = [];
        let paymentTransactions = [];
        let userOrders = [];

        // Enhanced admin check function
        async function checkAdminStatus() {
            try {

                if (!Utils.isAuthenticated()) {
                    return;
                }

                const response = await Utils.apiRequest('/api/admin/check-status');

                if (response.success && response.data.is_admin) {
                    // User is admin - show both admin button and panel
                    const adminLink = document.getElementById('adminLink');
                    const adminPanel = document.getElementById('adminAccessPanel');

                    if (adminLink) adminLink.classList.remove('hidden');
                    if (adminPanel) adminPanel.classList.remove('hidden');

                } else {
                    // Hide all admin elements
                    const adminLink = document.getElementById('adminLink');
                    const adminPanel = document.getElementById('adminAccessPanel');

                    if (adminLink) adminLink.classList.add('hidden');
                    if (adminPanel) adminPanel.classList.add('hidden');
                }
            } catch (error) {
                console.error('‚ùå Failed to check admin status:', error);
                // Hide all admin elements on error
                const adminLink = document.getElementById('adminLink');
                const adminPanel = document.getElementById('adminAccessPanel');

                if (adminLink) adminLink.classList.add('hidden');
                if (adminPanel) adminPanel.classList.add('hidden');
            }
        }

        async function loadDashboardData() {

            try {
                const token = Utils.getAuthToken();
                if (!token) {
                    throw new Error('No authentication token found');
                }

                // Load all data
                const walletResponse = await Utils.apiRequest('/api/wallet/transactions');
                walletTransactions = walletResponse.data || [];

                const paymentResponse = await Utils.apiRequest('/api/wallet/payment-transactions');
                paymentTransactions = paymentResponse.data || [];

                const ordersResponse = await Utils.apiRequest('/api/orders');
                userOrders = ordersResponse.data || [];

                await loadUserBalance();
                updateStatistics();
                displayRecentActivity();

                 // ‚úÖ ADD THIS LINE: Check admin status after loading dashboard data
                await checkAdminStatus();

            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                Utils.showAlert('Failed to load dashboard data: ' + error.message, 'error');
            }
        }

        async function loadUserBalance() {
            try {
                const response = await Utils.apiRequest('/api/auth/profile');
                if (response.success) {
                    document.getElementById('currentBalance').textContent = Utils.formatCurrency(response.data.balance || 0);
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) {
                        userNameElement.textContent = response.data.full_name || response.data.email || 'User';
                    }
                }
            } catch (error) {
                console.error('‚ùå Balance error:', error);
            }
        }

        function updateStatistics() {
            const successfulOrders = userOrders.filter(order =>
                ['success', 'completed', 'delivered'].includes(order.status?.toLowerCase())
            );

            const processingOrders = userOrders.filter(order =>
                ['processing', 'pending'].includes(order.status?.toLowerCase())
            );

            document.getElementById('totalOrders').textContent = userOrders.length;
            document.getElementById('successfulOrders').textContent = successfulOrders.length;
            document.getElementById('processingOrders').textContent = processingOrders.length;
        }

        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            const recentOrders = [...userOrders].slice(0, 10);

            if (recentOrders.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No recent orders</div>';
                return;
            }

            container.innerHTML = recentOrders.map(order => `
                <div class="activity-item">
                    <div>
                        <div class="activity-type">
                            ${order.data_plans?.name || 'Data Plan'} - ${order.phone_number}
                            <span class="status-${order.status}">(${order.status})</span>
                        </div>
                        <div class="activity-date">${Utils.formatDate(order.created_at)}</div>
                    </div>
                    <div class="activity-amount ${order.status === 'success' ? 'credit' : 'debit'}">
                        ${Utils.formatCurrency(order.amount_paid)}
                    </div>
                </div>
            `).join('');
        }

        // Initialize payment
        async function initializePayment(amountInputId, errorDivId) {
            try {
                const amountInput = document.getElementById(amountInputId);
                const errorDiv = document.getElementById(errorDivId);
                const amount = parseInt(amountInput.value);

                errorDiv.style.display = 'none';
                errorDiv.textContent = '';

                if (!amount || amount < 100) {
                    throw new Error('Please enter an amount of at least ‚Ç¶100');
                }

                const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                const userEmail = userProfile.email;
                if (!userEmail) {
                    throw new Error('User email not found. Please login again.');
                }

                // Get the current domain and construct callback URL
                const currentDomain = window.location.origin;
                const callbackUrl = `${currentDomain}/payment-verify.html`;

                console.log('üîÑ Sending callback URL to backend:', callbackUrl);

                // Call backend with explicit callback_url
                const response = await Utils.apiRequest('/api/wallet/initialize-payment', {
                    method: 'POST',
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        email: userEmail.trim().toLowerCase(),
                        callback_url: callbackUrl
                    })
                });

                if (response.success && response.data) {
                    if (response.data.authorization_url) {
                        window.location.href = response.data.authorization_url;
                    } else if (response.data.reference) {
                        Utils.showAlert(`Payment initialized! Reference: ${response.data.reference}`, 'success');
                        setTimeout(() => {
                            window.location.href = `/payment-verify?reference=${response.data.reference}`;
                        }, 2000);
                    } else {
                        Utils.showAlert('Payment initialized successfully!', 'success');
                    }
                    return response.data;
                } else {
                    throw new Error(response.error || 'Failed to initialize payment');
                }

            } catch (error) {
                const errorDiv = document.getElementById(errorDivId);
                if (errorDiv) {
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';
                } else {
                    Utils.showAlert(error.message, 'error');
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    Utils.logout();
                });
            }

            if (false && !Utils.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            loadDashboardData();
        });
    </script>

    <!-- Load Footer Component -->
    <script src="/js/components/footer.js"></script>
    <!-- Hamburger Menu -->
    <script src="/js/components/hamburger-menu.js"></script>
    <!-- Form Handler -->
    <script src="/js/components/simple-form-handler.js"></script>
</body>
</html>
